<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bima & Jasmine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --accent: #d4a373;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid rgba(212, 163, 115, 0.2);
        }

        .login-box h1 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .login-box input {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: var(--bg-dark);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 163, 115, 0.3);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 15px;
            display: none;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-header h1 {
            color: var(--accent);
            font-size: 1.5rem;
        }

        .dashboard-header .stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-box .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .btn-logout {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: white;
        }

        /* Wishes Table */
        .wishes-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
        }

        .wishes-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .wishes-table th,
        .wishes-table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .wishes-table th {
            background: rgba(212, 163, 115, 0.1);
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wishes-table td {
            font-size: 0.95rem;
        }

        .wishes-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .wishes-table .name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .wishes-table .message {
            color: var(--text-secondary);
            max-width: 400px;
        }

        .wishes-table .date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .btn-delete {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                padding: 15px;
            }

            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }

            .wishes-table {
                overflow-x: auto;
            }

            .wishes-table table {
                min-width: 600px;
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--danger);
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1><i class="fas fa-lock"></i> Admin Dashboard</h1>
            <p>Masukkan password untuk mengakses dashboard</p>
            <input type="password" id="passwordInput" placeholder="Password Admin"
                onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()"><i class="fas fa-sign-in-alt"></i> Masuk</button>
            <p class="login-error" id="loginError">Password salah!</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <h1><i class="fas fa-comments"></i> Manajemen Ucapan</h1>
            <div class="stats">
                <div class="stat-box">
                    <div class="number" id="totalWishes">0</div>
                    <div class="label">Total Ucapan</div>
                </div>
            </div>
            <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="wishes-table">
            <div id="wishesContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Memuat data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        let adminPassword = '';

        // Login
        function login() {
            const password = document.getElementById('passwordInput').value;

            // Verify with backend
            fetch('api/admin-wishes.php', {
                headers: {
                    'X-Admin-Password': password
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        adminPassword = password;
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        loadWishes();
                    } else {
                        document.getElementById('loginError').style.display = 'block';
                    }
                })
                .catch(() => {
                    document.getElementById('loginError').style.display = 'block';
                });
        }

        // Logout
        function logout() {
            adminPassword = '';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // Load wishes
        function loadWishes() {
            fetch('api/admin-wishes.php', {
                headers: {
                    'X-Admin-Password': adminPassword
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalWishes').textContent = data.total;
                        renderWishes(data.wishes);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('Gagal memuat data', 'error');
                });
        }

        // Render wishes table
        function renderWishes(wishes) {
            const container = document.getElementById('wishesContainer');

            if (wishes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Belum ada ucapan</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Pesan</th>
                            <th>Tanggal</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            wishes.forEach(wish => {
                html += `
                    <tr id="row-${wish.id}">
                        <td>#${wish.id}</td>
                        <td class="name">${wish.name}</td>
                        <td class="message">${wish.message}</td>
                        <td class="date">${formatDate(wish.created_at)}</td>
                        <td>
                            <button class="btn-delete" onclick="deleteWish(event, ${wish.id})">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Delete wish
        let lastDeletedWish = null; // Store for undo

        function deleteWish(e, id) {
            if (e && e.preventDefault) e.preventDefault();
            if (e && e.stopPropagation) e.stopPropagation();

            if (!confirm('Yakin ingin menghapus ucapan ini?')) return;

            // Ensure id is a number
            const wishId = parseInt(id, 10);

            const row = document.getElementById(`row-${wishId}`);
            const btn = row ? row.querySelector('.btn-delete') : null;

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            fetch('api/admin-wishes.php', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Password': adminPassword
                },
                body: JSON.stringify({ id: wishId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (row) row.remove();
                        const total = parseInt(document.getElementById('totalWishes').textContent);
                        document.getElementById('totalWishes').textContent = total - 1;

                        // Store for undo
                        lastDeletedWish = data.deleted;
                        showUndoToast(`Ucapan dari "${data.deleted.name}" dihapus`);
                    } else {
                        showToast(data.message || 'Gagal menghapus', 'error');
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                        }
                    }
                })
                .catch(err => {
                    console.error('Delete error:', err);
                    showToast('Gagal menghapus', 'error');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                    }
                });
        }

        // Undo delete
        function undoDelete() {
            if (!lastDeletedWish) return;

            fetch('api/admin-wishes.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Password': adminPassword
                },
                body: JSON.stringify({ restore: true, wish: lastDeletedWish })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('Ucapan berhasil dikembalikan!');
                        lastDeletedWish = null;
                        loadWishes(); // Reload the list
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(() => {
                    showToast('Gagal mengembalikan', 'error');
                });
        }

        // Format relative time (e.g., "5 menit lalu")
        function formatDate(dateStr) {
            const now = new Date();
            const past = new Date(dateStr);
            const diffMs = now - past;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            const diffWeek = Math.floor(diffDay / 7);
            const diffMonth = Math.floor(diffDay / 30);

            if (diffSec < 60) return 'Baru saja';
            if (diffMin < 60) return `${diffMin} menit lalu`;
            if (diffHour < 24) return `${diffHour} jam lalu`;
            if (diffDay < 7) return `${diffDay} hari lalu`;
            if (diffWeek < 4) return `${diffWeek} minggu lalu`;
            if (diffMonth < 12) return `${diffMonth} bulan lalu`;
            return past.toLocaleDateString('id-ID');
        }

        // Show toast with undo button
        function showUndoToast(message) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `${message} <button onclick="undoDelete()" style="margin-left:15px; background:#fff; color:#0f172a; border:none; padding:5px 12px; border-radius:5px; cursor:pointer; font-weight:600;">Undo</button>`;
            toast.className = 'toast show';

            setTimeout(() => {
                toast.className = 'toast';
                toast.textContent = '';
            }, 8000); // Longer time for undo
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');

            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
    </script>
</body>

</html>